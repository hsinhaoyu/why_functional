<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-03-25 Fri 08:35 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lazy trees</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Hsin-Hao Yu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Lazy trees</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0d6620a">1. Representing lazy trees</a></li>
<li><a href="#orgcf1fe92">2. The higher-order function <code>foldtree</code> for lazy trees</a></li>
<li><a href="#org07bb675">3. Summing all labels in a lazy tree</a></li>
<li><a href="#orgede1379">4. Flattening lazy trees</a></li>
<li><a href="#orge47f18f">5. Mapping functions to lazy trees</a></li>
<li><a href="#org3927364">6. Size of lazy trees</a></li>
<li><a href="#org12ee5f5">7. Depth of lazy trees</a></li>
<li><a href="#org66b0cd7">8. Appendix: imports</a></li>
</ul>
</div>
</div>
<p>
Recall that , we used the higher-order function <code>foldtree</code> to define functions that operate on trees. My Python code mirrors the code structure in the paper closely, but semantics is different: Because Hughes used a lazy functional language, his code works on lazy trees. With his code, you can generate a tree that is potentially infinite in size, and leave the users of the tree to decide which part of the tree will actually be evaluated. We have seen in the last three chapters that this pattern makes it possible to decompose complex loops into a chain of re-usable components.
</p>

<p>
Because Python is not a lazy language, we have to incorporate generators/iterators into <code>foldtree</code>.
</p>

<div id="outline-container-org0d6620a" class="outline-2">
<h2 id="org0d6620a"><span class="section-number-2">1</span> Representing lazy trees</h2>
<div class="outline-text-2" id="text-1">
<p>
As in , a lazy tree is a tuple with a label and a collection of subtrees. For laziness, the subtrees have to be stored in an iterator rather than in a list. Because we will use this structure a lot in the next chapter, I use a named tuple to differentiate a lazy tree from other tuples:
</p>
<div class="org-src-container">
<pre class="src src-python">Node = NamedTuple('Node', [('label', Any), ('subtrees', Optional[Iterator])])
</pre>
</div>

<p>
Let's build the same tree in , replacing lists with iterators: 
</p>
<div class="org-src-container">
<pre class="src src-python">&lt;&lt;TEST_LAZY_TREE_IMPORTS&gt;&gt;

def mk_tree_(label, lst):
    """A throw-away function just for this example"""
    if lst is None:
	return Node(label, None)
    else:
	return Node(label, iter(lst))

def mk_test_tree():
    my_tree = mk_tree_(1, [
			   mk_tree_(2, None),
			   mk_tree_(3, [mk_tree_(4, None)])
			  ])
    return my_tree
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcf1fe92" class="outline-2">
<h2 id="orgcf1fe92"><span class="section-number-2">2</span> The higher-order function <code>foldtree</code> for lazy trees</h2>
<div class="outline-text-2" id="text-2">
<p>
This is almost identical to the eager version defined in a . Unfortunately, some modifications are needed, because lists and iterators are manipulated differently in Python.
</p>
<div class="org-src-container">
<pre class="src src-python">def foldtree(f: Callable, g: Callable, a: Any, t: Union[Node, Iterator, None]):
    """Apply two functions (f and g) of two arguments to transform a lazy tree.
    f: combine the label of a node to its subtrees
    g: combine the subtrees of a node
    a: an initial constant
    t: a tree, a list of subtrees, or []
    """    
    if t is None:
	return a
    elif isinstance(t, tuple):
	(label, subtrees) = t
	return f(label, foldtree(f, g, a, subtrees))
    else:
	try:
	    subtree = next(t)
	    return g(foldtree(f, g, a, subtree),
		     foldtree(f, g, a, t))
	except StopIteration:
	    return a
</pre>
</div>
</div>
</div>

<div id="outline-container-org07bb675" class="outline-2">
<h2 id="org07bb675"><span class="section-number-2">3</span> Summing all labels in a lazy tree</h2>
<div class="outline-text-2" id="text-3">
<p>
As before, a variety of lazy tree operations can be implemented with <code>foldtree</code>, by using appropriate <code>f</code> and <code>g</code>.  
</p>
<div class="org-src-container">
<pre class="src src-python">def sumtree(t: Node) -&gt; int:
    add = operator.add
    return foldtree(add, add, 0, t)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python">def test_sumtree():
    t = mk_test_tree()
    assert sumtree(t) == 10

    t = mk_test_tree2()
    assert sumtree(t) == sum(range(1, 12))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgede1379" class="outline-2">
<h2 id="orgede1379"><span class="section-number-2">4</span> Flattening lazy trees</h2>
<div class="outline-text-2" id="text-4">
<p>
This version of <code>tree_labels</code> returns an iterator, which visits every label in the tree one by one:
</p>
<div class="org-src-container">
<pre class="src src-python">def tree_labels(t: Node) -&gt; Iterator:
    def f(label: Any, folded_subtrees: Iterator) -&gt; Iterator:
	yield label
	for item in folded_subtrees:
	    yield item

    def g(folded_first: Iterator, folded_rest: Iterator) -&gt; Iterator:
	for item in folded_first:
	    yield item
	for item in folded_rest:
	    yield item

    return foldtree(f, g, [], t)
</pre>
</div>

<p>
Let's try it. I use <code>list(t)</code> to convert the returned iterator to a regular list.
</p>
<div class="org-src-container">
<pre class="src src-python">def test_tree_labels():
    t = mk_test_tree()
    i = tree_labels(t)
    assert list(i) == [1, 2, 3, 4]

    t = mk_test_tree2()
    i = tree_labels(t)
    assert list(i) == list(range(1, 12))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge47f18f" class="outline-2">
<h2 id="orge47f18f"><span class="section-number-2">5</span> Mapping functions to lazy trees</h2>
<div class="outline-text-2" id="text-5">
<p>
This version of <code>maptree</code> maps a function <code>f</code> to all labels in a lazy tree, and returns another lazy tree. 
</p>
<div class="org-src-container">
<pre class="src src-python">def maptree(func: Callable, t: Node) -&gt; Node:
    def f(label: Any, folded_subtrees: Optional[Iterator]):
	return Node(func(label), folded_subtrees)

    def g(folded_first: Node, folded_rest: Optional[Iterator]) -&gt; Iterator:
	yield folded_first
	if folded_rest is not None:
	    for item in folded_rest:
		yield item

    return foldtree(f, g, None, t)
</pre>
</div>

<p>
Let's try it. I use the <code>tree_labels</code> function to collect all the labels in the returned lazy tree.
</p>
<div class="org-src-container">
<pre class="src src-python">def test_maptree():
    def f(n):
	return -1 * n

    t = mk_test_tree()
    t = maptree(f, t)
    t = tree_labels(t)
    assert list(t) == [-1, -2, -3, -4]

    t = mk_test_tree2()
    res = maptree(lambda x: -1 * x, t)
    res = tree_labels(res)
    assert list(res) == [-1 * i for i in range(1, 12)]
</pre>
</div>
</div>
</div>

<div id="outline-container-org3927364" class="outline-2">
<h2 id="org3927364"><span class="section-number-2">6</span> Size of lazy trees</h2>
<div class="outline-text-2" id="text-6">
<p>
Here's one more function that we'll use in the :
</p>
<div class="org-src-container">
<pre class="src src-python">def tree_size(t: Node) -&gt; int:
    def f(label, folded_subtrees):
	return 1 + folded_subtrees
    return foldtree(f, operator.add, 0, t)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python">def test_tree_size():
    t = mk_tree_(1, None)
    assert tree_size(t) == 1

    t = mk_test_tree()
    assert tree_size(t) == 4

    t = mk_test_tree2()
    assert tree_size(t) == 11
</pre>
</div>
</div>
</div>

<div id="outline-container-org12ee5f5" class="outline-2">
<h2 id="org12ee5f5"><span class="section-number-2">7</span> Depth of lazy trees</h2>
<div class="outline-text-2" id="text-7">
<p>
Another utility function:
</p>
<div class="org-src-container">
<pre class="src src-python">def tree_depth(t: Node) -&gt; int:
    def f(label: Any, folded_subtrees: int):
	return 1 + folded_subtrees

    def g(folded_first: int, folded_rest: int) -&gt; int:
	return max(folded_first, folded_rest)

    return foldtree(f, g, 0, t)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python">def test_tree_depth():
    t = mk_tree_(1, None)
    assert tree_depth(t) == 1

    t = mk_tree_(1, [mk_tree_(2, None)])
    assert tree_depth(t) == 2

    t = mk_test_tree()
    assert tree_depth(t) == 3

    t = mk_test_tree2()
    assert tree_depth(t) == 5
</pre>
</div>
</div>
</div>

<div id="outline-container-org66b0cd7" class="outline-2">
<h2 id="org66b0cd7"><span class="section-number-2">8</span> Appendix: imports</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">
<pre class="src src-python">from lazy_utils import *

def mk_test_tree2():
    my_tree = mk_tree_(1, [
			   mk_tree_(2, [
					mk_tree_(3, None),
					mk_tree_(4, [
						     mk_tree_(5, None),
						     mk_tree_(6, [
								  mk_tree_(7, None)
								 ])]),
					mk_tree_(8, [mk_tree_(9, None)])
				       ]),
			   mk_tree_(10, [mk_tree_(11, None)])
			  ])
    return my_tree
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Hsin-Hao Yu</p>
<p class="date">Created: 2022-03-25 Fri 08:35</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
